window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,urls={proxy:"http://b2-apps.appspot.com/",api:"www.thetvdb.com/api/",id:"C973590B1E212580",banner:"www.thetvdb.com/banners/",search:"GetSeries.php",update:"https://dl.dropbox.com/u/51320501/tv-version.json",trakt:"http://api.trakt.tv/",trakt_api:"b3795664d41ef84ecdbf1dae6dfab099",img_url:"slurm.trakt.us/"},u={search:urls.trakt+"search/shows.json/"+urls.trakt_api+"/",img:urls.proxy+urls.img_url,episode:urls.trakt+"show/season.json/"+urls.trakt_api+"/",poster:"slurm.trakt.us/images/posters/"};var tv={};tv.ui={},tv.network={},tv.indexedDB={};var DB="tv_man",DB_show="tv_shows",DB_epi="tv_episodes",DB_img="tv_images";tv.ui.getDate=function(e){null==e&&(e=0);var t="",o=new Date;o.setDate(o.getDate()+e);var n=o.getDate(),s=o.getMonth()+1,i=o.getFullYear();return 10>n&&(n="0"+n),10>s&&(s="0"+s),t=i+"-"+s+"-"+n},tv.ui.formatDate=function(e){if(null==e||void 0==e||e.length<10)return"Not specified";var t=e.split("-"),o=t[2]+"-"+t[1]+"-"+t[0];return o},tv.ui.getDataUrl=function(e,t,o){var n=URL.createObjectURL(o),s=new Image,i=document.createElement("canvas");s.onload=function(){var s=300,a=s*(this.height/this.width);i.width=s,i.height=a;var r=i.getContext("2d");r.drawImage(this,0,0,s,a);var d=i.toDataURL(o.type);URL.revokeObjectURL(n);var u={};u.showid=e.showid,u.img=d,tv.indexedDB.addShow(e,t,u)},s.src=n},tv.ui.getImgId=function(e){var t=e.substring(e.lastIndexOf("/")+1,e.length);return t},tv.network.getAllData=function(e){$.console({message:"Downloading episode details."}),$.ajax({url:urls.proxy+urls.api+urls.id+"/series/"+e.showid+"/all/en.xml",type:"GET",dataType:"xml",success:function(t){$.console({message:"Episode details downloaded."});var o={};$(t).find("Series").each(function(){o.showid=$(this).find("id").text(),o.poster=$(this).find("poster").text(),o.name=$(this).find("SeriesName").text()});var n=[];$(t).find("Episode").each(function(){var e={};e.name=$(this).find("EpisodeName").text(),e.showname=o.name,e.showid=$(this).find("seriesid").text(),e.episodeID=$(this).find("id").text(),e.overview=$(this).find("Overview").text(),e.guestStars=$(this).find("GuestStars").text(),e.airdate=$(this).find("FirstAired").text(),e.season=$(this).find("SeasonNumber").text(),e.episode=$(this).find("EpisodeNumber").text(),e.lastUpdated=$(this).find("lastupdated").text(),n.push(e)});var s=urls.proxy+u.poster+tv.ui.getImgId(e.images.poster);$.console({message:"Downloading show poster."});var i=new XMLHttpRequest;i.responseType="blob",i.onload=function(){$.console({message:"Poster downloaded."}),tv.ui.getDataUrl(e,n,this.response)},i.onerror=function(e){console.log(e)},i.open("GET",s,!0),i.send()},error:function(){$.console({message:"Episode list not downloaded. Try to add the show again.",type:"error"})}})},tv.network.getPoster=function(e,t){$.console({message:"Downloading show poster."});var o=new XMLHttpRequest;o.responseType="blob",o.onload=function(){$.console({message:"Poster downloaded."}),tv.ui.getDataUrl(this.response,e)},o.open("GET",t,!0),o.send()},tv.network.getEpisode=function(e,t){$.console({message:"Updating episode information."});var o=urls.proxy+urls.api+urls.id+"/episodes/"+e+"/en.xml";$.ajax({url:o,type:"GET",dataType:"xml",success:function(e){var o={};return $(e).find("Episode").each(function(){o.name=$(this).find("EpisodeName").text(),o.showname=t,o.showid=$(this).find("seriesid").text(),o.episodeID=$(this).find("id").text(),o.overview=$(this).find("Overview").text(),o.guestStars=$(this).find("GuestStars").text(),o.airdate=$(this).find("FirstAired").text(),o.season=$(this).find("SeasonNumber").text(),o.episode=$(this).find("EpisodeNumber").text(),o.lastUpdated=$(this).find("lastupdated").text()}),""==o.overview||o.overview.length<5?($.console({message:"Detail of this episode is not yet available."}),void 0):(tv.indexedDB.updateEpisode(o),void 0)},error:function(){$.console({message:"Episode details could not be downloaded.",type:"error"})}})},tv.indexedDB.db=null,tv.indexedDB.open=function(e){var t=1,o=indexedDB.open(DB,t);o.onupgradeneeded=function(e){var t=e.target.result;e.target.transaction.onerror=tv.indexedDB.onerror;var o=t.createObjectStore(DB_show,{keyPath:"showid"});o.createIndex("title","title",{unique:!1}),o.createIndex("air_day","air_day",{unique:!1});var n=t.createObjectStore(DB_epi,{keyPath:"episodeID"});n.createIndex("showid","showid",{unique:!1}),n.createIndex("airdate","airdate",{unique:!1}),n.createIndex("showSeason",["showid","season"],{unique:!1}),n.createIndex("showSeasonEpisode",["showid","season","episode"],{unique:!0}),t.createObjectStore(DB_img,{keyPath:"showid"})},o.onsuccess=function(t){tv.indexedDB.db=t.target.result,"back"===e?tv.indexedDB.getTodayCount():"info"===e||tv.indexedDB.getAll()},o.onerror=tv.indexedDB.onerror},tv.indexedDB.getToday=function(){var e=tv.indexedDB.db,t=e.transaction([DB_epi],"readwrite"),o=t.objectStore(DB_epi),n=tv.ui.getDate(),s=o.index("airdate"),i=IDBKeyRange.only(n),a=s.openCursor(i);a.onsuccess=function(e){var t=e.target.result;t&&(tv.ui.renderPopup(t.value),console.log(t.value),t.continue())}},tv.indexedDB.getTodayCount=function(){var e=tv.indexedDB.db,t=e.transaction([DB_epi],"readwrite"),o=t.objectStore(DB_epi),n=tv.ui.getDate(),s=o.index("airdate"),i=IDBKeyRange.only(n),a=s.count(i);a.onsuccess=function(e){var t=e.target.result;t.toString();var o;o=0==t?webkitNotifications.createNotification("tv128.png","TV!","No shows today."):webkitNotifications.createNotification("tv128.png","TV!",t+" "+(t>1?"shows":"show")+" today."),o.show(),setTimeout(function(){o.cancel()},5e3)}},tv.indexedDB.addShow=function(e,t,o){var n=tv.indexedDB.db,s=n.transaction([DB_show,DB_epi,DB_img],"readwrite");s.oncomplete=function(){$.console({message:"Show "+e.title+" saved. You can now close this box.",type:"success"});var t=angular.element($("#addShow")).scope();t.shows=[],t.isShown=!1,tv.indexedDB.getAll()},s.onabort=function(){$.console({message:"This show already exists or some error encountered. Show not saved."})};var i=s.objectStore(DB_show),a=s.objectStore(DB_epi),r=s.objectStore(DB_img),d=i.add(e);d.onerror=function(){$.console({message:"There was an error.",type:"error"}),s.abort()};for(var u=0;u<t.length;u++)a.add(t[u]);r.add(o)},tv.indexedDB.getAll=function(){var e={},t={},o={},n=[],s=[],i=tv.indexedDB.db,a=i.transaction([DB_show,DB_epi,DB_img],"readonly"),r=angular.element($("#todayList")).scope(),d=angular.element($("#showList")).scope();r.shows=d.shows=[],r.noUpcoming=!0,a.oncomplete=function(){for(var i in e)e[i].img=o[e[i].data.showid].img,e.hasOwnProperty(i)&&n.push(e[i]);for(var i in t)t[i].img=o[t[i].data.showid].img,t.hasOwnProperty(i)&&s.push(t[i]);r.$apply(function(){r.shows=s,r.shows.length>0?r.noUpcoming=!1:(r.noUpcoming=!0,r.info="No upcoming shows.")}),d.$apply(function(){d.shows=n,d.shows.length>0?d.noAdded=!1:(d.noAdded=!0,d.info="No shows added.")})};var u,c,l,p=a.objectStore(DB_show);p.openCursor().onsuccess=function(t){u=t.target.result,u&&(e[u.value.showid]||(e[u.value.showid]={}),e[u.value.showid].data=u.value,u.continue())};var v=a.objectStore(DB_epi),w=tv.ui.getDate(-1),h=tv.ui.getDate(5),g=v.index("airdate"),D=IDBKeyRange.bound(w,h,!1,!1);g.openCursor(D).onsuccess=function(e){c=e.target.result,c&&(t[c.value.episodeID]||(t[c.value.episodeID]={}),t[c.value.episodeID].data=c.value,c.continue())};var f=a.objectStore(DB_img);f.openCursor().onsuccess=function(e){l=e.target.result,l&&(o[l.value.showid]||(o[l.value.showid]={}),o[l.value.showid].img=l.value.img,l.continue())}},tv.indexedDB.deleteShowComplete=function(e){var t=tv.indexedDB.db,o=t.transaction([DB_show,DB_epi,DB_img],"readwrite");o.oncomplete=function(){$.console({message:"Show deleted."}),tv.indexedDB.getAll()},o.onerror=function(){$.console({message:"Error during deletion.",type:"error"})};var n=o.objectStore(DB_show);n.delete(e);var s=o.objectStore(DB_img);s.delete(e);var i=o.objectStore(DB_epi),a=i.index("showid"),r=new IDBKeyRange.only(e.toString()),d=a.openCursor(r);d.onsuccess=function(e){var t=e.target.result;t&&(t.delete(),t.continue())}},tv.indexedDB.getEpisodeDetail=function(e,t,o){var n=tv.indexedDB.db,s=n.transaction([DB_epi],"readonly"),i=s.objectStore(DB_epi),a=i.index("showSeasonEpisode"),r=new IDBKeyRange.only([e.toString(),t.toString(),o.toString()]),d=angular.element($("#showInfo")).scope();a.count(r).onsuccess=function(e){if(e.target.result>0){var n=a.openCursor(r);n.onsuccess=function(e){var t=e.target.result;t&&(d.episode=t.value,d.error=!1,d.showDetails=!0)}}else $.console({message:"No info found for season "+t+" episode "+o,heading:"Error..."})}},tv.indexedDB.exists=function(e){var t=tv.indexedDB.db,o=t.transaction([DB_show],"readonly");o.objectStore(DB_epi),epiStore.index("showid");var n=new IDBKeyRange.only(e.toString());epiIndex.count(n).onsuccess=function(e){return e.target.result>0?!0:($.console({message:"This show already exists",type:"error"}),void 0)}},tv.indexedDB.updateEpisode=function(e){var t=tv.indexedDB.db,o=t.transaction([DB_epi],"readwrite"),n=o.objectStore(DB_epi),s=IDBKeyRange.only(e.episodeID),i=n.openCursor(s);i.onsuccess=function(t){var o=t.target.result,n=o.update(e);n.onsuccess=function(){$.console({message:"Episode details updated.",type:"success"}),tv.indexedDB.getAll()}}};