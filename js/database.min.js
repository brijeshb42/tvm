window.indexedDB=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,window.IDBTransaction=window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,window.IDBKeyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange,urls={proxy:"http://b2-apps.appspot.com/",api:"www.thetvdb.com/api/",id:"C973590B1E212580",banner:"www.thetvdb.com/banners/",search:"GetSeries.php",update:"https://dl.dropbox.com/u/51320501/tv-version.json",trakt:"http://api.trakt.tv/",trakt_api:"b3795664d41ef84ecdbf1dae6dfab099",img_url:"slurm.trakt.us/"},u={search:urls.trakt+"search/shows.json/"+urls.trakt_api+"/",img:urls.proxy+urls.img_url,episode:urls.trakt+"show/season.json/"+urls.trakt_api+"/",poster:"slurm.trakt.us/images/posters/"};var tv={};tv.ui={},tv.network={},tv.indexedDB={};var DB="tv_man",DB_show="tv_shows",DB_epi="tv_episodes",DB_img="tv_images";tv.ui.getDate=function(e){null==e&&(e=0);var o="",t=new Date;t.setDate(t.getDate()+e);var n=t.getDate(),i=t.getMonth()+1,r=t.getFullYear();return 10>n&&(n="0"+n),10>i&&(i="0"+i),o=r+"-"+i+"-"+n},tv.ui.formatDate=function(e){if(null==e||void 0==e||e.length<10)return"Not specified";var o=e.split("-"),t=o[2]+"-"+o[1]+"-"+o[0];return t},tv.ui.getDataUrl=function(e,o){var t=URL.createObjectURL(e),n=new Image,i=document.createElement("canvas");n.onload=function(){var n=300,r=n*(this.height/this.width);i.width=n,i.height=r;var s=i.getContext("2d");s.drawImage(this,0,0,n,r);var a=i.toDataURL(e.type);URL.revokeObjectURL(t);var d={};d.showid=o,d.img=a,tv.indexedDB.savePoster(d)},n.src=t},tv.network.getPoster=function(e,o){$.console({message:"Downloading show poster."});var t=new XMLHttpRequest;t.responseType="blob",t.onload=function(){$.console({message:"Poster downloaded."}),tv.ui.getDataUrl(this.response,e)},t.open("GET",o,!0),t.send()},tv.indexedDB.db=null,tv.indexedDB.open=function(e){var o=1,t=indexedDB.open(DB,o);t.onupgradeneeded=function(e){var o=e.target.result;e.target.transaction.onerror=tv.indexedDB.onerror;var t=o.createObjectStore(DB_show,{keyPath:"showid"});t.createIndex("title","title",{unique:!1}),t.createIndex("air_day","air_day",{unique:!1});var n=o.createObjectStore(DB_epi,{keyPath:"episodeID"});n.createIndex("showid","showid",{unique:!1}),n.createIndex("airdate","airdate",{unique:!1}),n.createIndex("season","season",{unique:!1}),n.createIndex("episode","episode",{unique:!1}),o.createObjectStore(DB_img,{keyPath:"showid"})},t.onsuccess=function(o){tv.indexedDB.db=o.target.result,console.log("DB Opened."),"back"===e?tv.indexedDB.getTodayCount():"info"===e||tv.indexedDB.getAll()},t.onerror=tv.indexedDB.onerror},tv.indexedDB.addShow=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_show],"readwrite"),n=t.objectStore(DB_show),i=n.add(e),r=angular.element($("#addShow")).scope();i.onsuccess=function(){$.console({message:"Show details saved."}),r.$apply(function(){r.epi=!0})},i.onerror=function(){$.console({message:"Error while adding show "+e.title+" or this show is already present."}),r.$apply(function(){r.epi=!1})}},tv.indexedDB.getAllShows=function(){var e=tv.indexedDB.db,o=e.transaction([DB_show],"readonly"),t=o.objectStore(DB_show),n=t.count(),i=angular.element($("#showList")).scope();n.onsuccess=function(){if(n.result>0){i.$apply(function(){i.shows=[]});var e=IDBKeyRange.lowerBound(0),o=t.openCursor(e);o.onsuccess=function(e){var o=e.target.result;0!=!!o&&(i.$apply(function(){i.shows.push(o.value)}),o.continue())},o.onerror=function(e){console.log("Error."),console.log(e)}}else i.$apply(function(){i.shows=[{title:"No Show Added Yet.",next:"",overview:""}]})},n.onerror=function(e){console.log("Error."),console.log(e)}},tv.indexedDB.addEpisodes=function(e,o){for(var t=tv.indexedDB.db,n=t.transaction([DB_epi],"readwrite"),i=n.objectStore(DB_epi),r=0,s=angular.element($("#addShow")).scope(),a=0;a<e.length;a++){var d=i.add(e[a]);d.onsuccess=function(){r++,r==e.length&&($.console({message:"Episode details for "+o.name+" saved."}),s.$apply(function(){s.img=!0}))},d.onerror=function(){$.console({message:"Error while adding episode details for "+o.title}),s.$apply(function(){s.img=!1})}}},tv.indexedDB.getEpisodes=function(){var e=tv.indexedDB.db,o=e.transaction([DB_epi],"readonly"),t=o.objectStore(DB_epi),n=IDBKeyRange.lowerBound(0),i=t.openCursor(n);i.onsuccess=function(e){var o=e.target.result;0!=!!o&&(tv.ui.renderShows(o.value),o.continue())},i.onerror=function(){console.log("Error getting episode.")}},tv.indexedDB.deleteShow=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_show],"readwrite"),n=t.objectStore(DB_show),i=n.delete(e.toString());i.onsuccess=function(){tv.ui.renderHome(),tv.indexedDB.deleteShowImg(e.toString())},i.onerror=function(){console.log("Error deleting show.")}},tv.indexedDB.deleteShowImg=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_img],"readwrite"),n=t.objectStore(DB_img),i=n.delete(e);i.onsuccess=function(){bootbox.alert("Show deleted.",function(){tv.indexedDB.deleteShowEpisodes(e)})},i.onerror=function(e){console.log(e)}},tv.indexedDB.deleteShowEpisodes=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_epi],"readwrite"),n=t.objectStore(DB_epi),i=n.index("showid"),r=new IDBKeyRange.only(e),s=i.openCursor(r);s.onsuccess=function(e){var o=e.target.result;o&&(o.delete(),o.continue())},s.onerror=function(){bootbox.alert("Error opening DB.")}},tv.indexedDB.savePoster=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_img],"readwrite"),n=t.objectStore(DB_img),i=n.add(e);i.onsuccess=function(){$.console({message:"Poster saved."})},i.onerror=function(){$.console({message:"Error saving poster."})}},tv.indexedDB.getPoster=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_img],"readonly"),n=t.objectStore(DB_img),i=n.get(e);i.onsuccess=function(){tv.ui.renderImg(i.result)}},tv.indexedDB.getToday=function(){var e=tv.indexedDB.db,o=e.transaction([DB_epi],"readwrite"),t=o.objectStore(DB_epi),n=tv.ui.getDate(),i=t.index("airdate"),r=IDBKeyRange.only(n),s=i.openCursor(r);s.onsuccess=function(e){var o=e.target.result;o&&(tv.ui.renderPopup(o.value),console.log(o.value),o.continue())}},tv.indexedDB.getTodayCount=function(){var e=tv.indexedDB.db,o=e.transaction([DB_epi],"readwrite"),t=o.objectStore(DB_epi),n=tv.ui.getDate(),i=t.index("airdate"),r=IDBKeyRange.only(n),s=i.count(r);s.onsuccess=function(e){var o=e.target.result;o.toString(),console.log(o);var t;t=0==o?webkitNotifications.createNotification("tv128.png","TV!","No shows today."):webkitNotifications.createNotification("tv128.png","TV!",o+" "+(o>1?"shows":"show")+" today."),t.show()}},tv.indexedDB.getAll=function(){var e={},o={},t={},n=[],i=[],r=tv.indexedDB.db,s=r.transaction([DB_show,DB_epi,DB_img],"readonly"),a=angular.element($("#todayList")).scope(),d=angular.element($("#showList")).scope();a.shows=d.shows=[],a.noUpcoming=!0,s.oncomplete=function(){console.log("All transaction complete.");for(var r in e)e[r].img=t[e[r].data.showid].img,e.hasOwnProperty(r)&&n.push(e[r]);for(var r in o)o[r].img=t[o[r].data.showid].img,o.hasOwnProperty(r)&&i.push(o[r]);a.$apply(function(){a.shows=i,a.shows.length>0?a.noUpcoming=!1:(a.noUpcoming=!0,a.info="No upcoming shows.")}),d.$apply(function(){d.shows=n,d.shows.length>0?d.noAdded=!1:(d.noAdded=!0,d.info="No shows added.")})};var c,u,l,g=s.objectStore(DB_show);g.openCursor().onsuccess=function(o){c=o.target.result,c&&(e[c.value.showid]||(e[c.value.showid]={}),e[c.value.showid].data=c.value,c.continue())};var v=s.objectStore(DB_epi),w=tv.ui.getDate(-1),D=tv.ui.getDate(5),p=v.index("airdate"),B=IDBKeyRange.bound(w,D,!1,!1);p.openCursor(B).onsuccess=function(e){u=e.target.result,u&&(o[u.value.episodeID]||(o[u.value.episodeID]={}),o[u.value.episodeID].data=u.value,u.continue())};var h=s.objectStore(DB_img);h.openCursor().onsuccess=function(e){l=e.target.result,l&&(t[l.value.showid]||(t[l.value.showid]={}),t[l.value.showid].img=l.value.img,l.continue())}},tv.indexedDB.deleteShowComplete=function(e){var o=tv.indexedDB.db,t=o.transaction([DB_show,DB_epi,DB_img],"readwrite");t.oncomplete=function(){tv.indexedDB.getAll()},t.onerror=function(){console.log("error during deleteion")};var n=t.objectStore(DB_show),i=n.delete(e);i.onsuccess=function(){console.log("show details deleted")},i.onerror=function(){console.log("Error deleting show details.")};var r=t.objectStore(DB_img),s=r.delete(e);s.onsuccess=function(){console.log("show img deleted")},s.onerror=function(){console.log("show img not deleted")};var a=t.objectStore(DB_epi),d=a.index("showid"),c=new IDBKeyRange.only(e.toString()),u=d.openCursor(c);u.onsuccess=function(e){var o=e.target.result;o&&(o.delete(),o.continue())},u.onerror=function(){console.log("Error opening DB.")}};